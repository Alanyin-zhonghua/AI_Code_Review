# 目标

* 基于规格文档与现有代码骨架，完成本地端到端验证、依赖安装、配置密钥与使用示例，并给出问题修复路径。

## 环境与依赖

* Python 3.12（Windows）。

* 安装依赖：`httpx`、`pydantic`、`pytest`（建议 `pip install httpx pydantic pytest` 或使用 `poetry`）。

* 新建 `.env` 并写入：

  * `KIMI_API_KEY=<你的密钥>`（将你提供的 `api=sk-...` 值填入等号右侧，不要把 `api=` 前缀包含进去）。

  * 可选：`AGENT_LOG_REDACT_CONTENT=true`（启用日志内容脱敏）。

## 验证步骤

1. 运行测试：`pytest -q agent_core/tests`。

   * 预期：

     * JSON 存储创建与读写通过（`test_json_store.py`）。

     * Provider 响应解析与错误路径通过（`test_kimi_client.py`）。

     * Agent 路径裁剪与写回通过（`test_agent_flow.py`）。
2. 快速调用：

   * `from agent_core.api.service import run_ide_chat`

   * `print(run_ide_chat("你好"))`

   * 查看返回的 `conversation_id`、`user/assistant` 消息内容。
3. 存储与日志检查：

   * `.storage/conversations/<id>/meta.json`、`messages.jsonl` 内容与时间戳格式是否正确（UTC、`Z`）。

   * `logs/agent.log` 是否为 JSON 行（包含时间、级别、模块、消息）。

## Kimi 接入验证

* 设置真实 `KIMI_API_KEY` 后：

  * 调用一次 `KimiClient.chat`，确认 429/4xx 异常抛出与成功解析 `choices/usage`。

  * 若网络/限流导致失败：记录异常并给出重试/退避建议（当前版本仅抛异常，后续在 Agent 层加重试）。

## IDE 集成指引

* 通过 `get_default_agent()` 获取单例；或自定义注入 `JsonConversationStore` 与 `KimiClient`。

* 支持会话分叉：传入已有 `conversation_id` 与 `focus_message_id`。

## 安全与约束

* 不在日志中记录明文密钥；启用脱敏开关时仅记录前 N 字符+哈希。

* 工具只读：拒绝 `..` 与绝对路径；不越权访问。

* 禁用系统代理：HTTP 客户端 `trust_env=false`。

## 可能问题与修复

* Windows 路径权限：确保对 `.storage` 与 `logs` 有写权限；若失败，使用 `Path(...).mkdir(parents=True, exist_ok=True)` 修复。

* 依赖安装失败：确认 Python/`pip` 环境，必要时切换镜像或使用 `poetry`。

## 后续增强

* 扩展工具：`list_files`、`search_code`、`propose_edit`（只生成补丁）。

* Agent 层加入限流重试与最多 5 轮工具循环。

* 预留 `sqlite_store.py` 接口骨架与 TODO。

请确认以上计划，我将立即执行：安装依赖、写入 `.env`、运行测试与一次端到端调用，并把结果与日志/存储检查报告发回。
